<!doctype html>
<html lang="th">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>‡πÄ‡∏Å‡πá‡∏ö‡∏î‡∏≤‡∏ß‡∏Å‡∏±‡∏ô‡∏•‡∏π‡∏Å‡πÜ</title>
  <!-- ‡∏ü‡∏≠‡∏ô‡∏ï‡πå Prompt ‡∏à‡∏≤‡∏Å Google (‡πÄ‡∏´‡∏°‡∏≤‡∏∞‡∏Å‡∏±‡∏ö GitHub Pages) -->
  <link href="https://fonts.googleapis.com/css2?family=Prompt:wght@400;700&display=swap" rel="stylesheet">
  <style>
    :root{
      --panel:#ffffff; --panel2:#f0f4ff;
      --text:#1b2559; --muted:#5c6fb0;
      --primary:#6c63ff; --primaryDark:#4f46e5;
      --danger:#ef4444;
      --shadow: 0 10px 24px rgba(30,41,59,.12);
    }
    *{box-sizing:border-box} html,body{height:100%;margin:0}
    body{
      font-family:'Prompt',ui-rounded,ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,"Helvetica Neue",Arial;
      color:var(--text); display:flex; align-items:center; justify-content:center; padding:16px;
      transition: background 600ms ease;
      background-size: 120% 120%, 140% 140%, 100% 100%;
      animation: pastelDrift 18s ease-in-out infinite alternate;
    }
    @keyframes pastelDrift{
      0%{ background-position: 10% 0%, 90% 100%, 0% 0%; }
      100%{ background-position: 30% 10%, 110% 90%, 0% 0%; }
    }

    .container{width:100%; max-width:1100px}
    h1{margin:0; font-size:34px; letter-spacing:.2px; color:#1f2a5f; font-weight:700}
    .row{display:flex; gap:12px; align-items:flex-end; justify-content:space-between; margin-bottom:12px; flex-wrap:wrap}
    .controls{display:flex; gap:10px; flex-wrap:wrap; align-items:center}
    .btn{
      appearance:none; border:0; background:var(--primary);
      color:#fff; padding:14px 18px; border-radius:16px; font-weight:700; cursor:pointer;
      box-shadow: var(--shadow); font-size:16px; letter-spacing:.2px;
      transition:transform .05s ease, filter .15s ease; touch-action: manipulation;
    }
    .btn:hover{filter:brightness(1.05)} .btn:active{transform:scale(.98)}
    .btn.secondary{background:#94a3ff; color:#0b0f2a}
    .btn.ghost{background:#e8edff; color:#18224d}
    .btn.danger{background:var(--danger)}
    .btn.big{font-size:18px; padding:16px 22px; border-radius:18px}
    .btn:disabled{opacity:.6; cursor:not-allowed}

    .hud{display:grid; grid-template-columns:repeat(8, minmax(100px,1fr)); gap:12px; margin-bottom:16px}
    .card{
      background:var(--panel); border:1px solid #e5eaff; border-radius:16px; padding:10px 12px;
      display:flex; align-items:center; justify-content:space-between; box-shadow: var(--shadow)
    }
    .card small{color:var(--muted); font-size:13px}
    .tog{display:flex; gap:8px; align-items:center}
    .tog input{width:20px; height:20px}

    .boardWrap{position:relative}
    .board{
      outline:none; position:relative; margin:0 auto; border-radius:22px; border:3px solid #e5eaff;
      background:linear-gradient(180deg, #f8fbff, #edf2ff); padding:10px; box-shadow: var(--shadow); overflow:hidden
    }
    .board.lowtime{animation: pulseBorder .6s ease-in-out infinite}
    @keyframes pulseBorder{
      0%{ border-color:#e5eaff } 50%{ border-color:#ffb4b4 } 100%{ border-color:#e5eaff }
    }

    .grid{display:grid}
    .cell{
      position:relative; margin:2px; border-radius:12px; background:#e9efff;
      width:44px; height:44px; border:1px solid #dbe3ff; overflow:visible
    }
    .coin{position:absolute; inset:0; display:flex; align-items:center; justify-content:center; font-size:24px; user-select:none}
    .pop{
      position:absolute; left:50%; top:-6px; transform:translate(-50%,-100%);
      background:#00000070; color:#fff; font-size:12px; padding:2px 6px; border-radius:10px; pointer-events:none;
      animation: popfade .7s ease forwards
    }
    @keyframes popfade{
      0%{opacity:0; transform:translate(-50%,-60%)} 
      30%{opacity:1; transform:translate(-50%,-100%)} 
      100%{opacity:0; transform:translate(-50%,-140%)}
    }

    .player{
      position:absolute; inset:0; margin:5px; border-radius:10px; display:flex; align-items:center; justify-content:center;
      font-size:24px; user-select:none; color:#fff; font-weight:700
    }
    .mickie{background:linear-gradient(180deg, #60a5fa, #3b82f6)}
    .indy{background:linear-gradient(180deg, #34d399, #10b981)}

    /* overlays */
    .overlay{
      position:absolute; inset:0; display:flex; align-items:center; justify-content:center; pointer-events:none; z-index:900;
    }
    .gameover{
      position:absolute; inset:0; display:none; align-items:center; justify-content:center; pointer-events:auto; z-index:1000;
    }
    .overlayBox{
      padding:14px 18px; background:#00000060; border:1px solid #ffffff50; border-radius:18px;
      font-weight:700; text-align:center; color:#fff; box-shadow: var(--shadow)
    }
    .goPanel{
      padding:26px 28px; background:#111827cc; border:1px solid #ffffff40; border-radius:22px;
      text-align:center; max-width:92%; color:#fff; box-shadow: var(--shadow)
    }
    .goTitle{font-size:48px; font-weight:700; margin-bottom:10px}
    .goSub{color:#e5edff; margin-bottom:18px}

    /* Character Select Modal */
    .charselect{
      position:fixed; inset:0; display:flex; align-items:center; justify-content:center;
      background:rgba(10,15,40,.45); z-index:1200;
    }
    .charbox{
      background:#fff; color:#0b1540; border-radius:22px; border:1px solid #e6eaff; padding:22px; width:min(720px, 92%);
      box-shadow: 0 20px 40px rgba(0,0,0,.15);
    }
    .charbox h2{margin:0 0 12px; font-size:24px}
    .charoptions{display:grid; grid-template-columns:1fr 1fr; gap:12px; margin:12px 0 16px}
    .charopt{
      border:2px solid #e4e8ff; border-radius:16px; padding:14px; display:flex; gap:12px; align-items:center; cursor:pointer;
      font-weight:700; font-size:18px; background:#f9fbff;
    }
    .charopt .emo{font-size:28px}
    .charopt.active{border-color:#6c63ff; box-shadow:0 0 0 4px #edf0ff}
    .charactions{display:flex; gap:10px; justify-content:flex-end}
    .note{color:#4b5aa8; font-size:13px}

    /* D-Pad */
    .pad{
      position:fixed; right:20px; bottom:20px; display:grid;
      grid-template-columns:64px 64px 64px; grid-template-rows:64px 64px 64px; gap:10px; z-index:1300
    }
    .pad .pbtn{
      background:#ffffff; color:#1b2559; border:2px solid #e5eaff; border-radius:16px; box-shadow: var(--shadow);
      display:flex; align-items:center; justify-content:center; font-size:20px; font-weight:700; cursor:pointer; user-select:none
    }
    .pad .pbtn:active{transform:scale(.97)}
    .pad .blank{background:transparent; border:none; box-shadow:none}

    @media (max-width:1100px){ .hud{grid-template-columns:repeat(4,1fr)} }
    @media (max-width:520px){
      .hud{grid-template-columns:repeat(2,1fr)}
      .pad{right:12px; bottom:12px; gap:8px}
      .pad .pbtn{width:56px; height:56px}
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="row">
      <h1>‡πÄ‡∏Å‡πá‡∏ö‡∏î‡∏≤‡∏ß‡∏Å‡∏±‡∏ô‡∏•‡∏π‡∏Å‡πÜ</h1>
      <div class="controls" id="menu">
        <div class="picker" id="picker"></div>
        <button class="btn big" id="pauseBtn" style="display:none;">‡∏´‡∏¢‡∏∏‡∏î‡∏û‡∏±‡∏Å (P)</button>
        <button class="btn secondary big" id="restartBtn" style="display:none;">‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏î‡πà‡∏≤‡∏ô‡∏ô‡∏µ‡πâ‡πÉ‡∏´‡∏°‡πà</button>
        <button class="btn ghost big" id="backBtn" style="display:none;">‡∏Å‡∏•‡∏±‡∏ö‡πÄ‡∏°‡∏ô‡∏π</button>
      </div>
    </div>

    <div class="hud">
      <div class="card"><small>‡∏ï‡∏±‡∏ß‡∏•‡∏∞‡∏Ñ‡∏£</small><b id="hudChar">-</b></div>
      <div class="card"><small>‡∏î‡πà‡∏≤‡∏ô</small><b id="hudLevel">1</b></div>
      <div class="card"><small>‡∏Ç‡∏≠‡∏á‡∏ó‡∏µ‡πà‡πÄ‡∏Å‡πá‡∏ö</small><b id="hudCoins">0/3</b></div>
      <div class="card"><small>‡πÄ‡∏ß‡∏•‡∏≤</small><b id="hudTime">25s</b></div>
      <div class="card"><small>‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô</small><b id="hudScore">0</b></div>
      <div class="card"><small>‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î</small><b id="hudBest">M:L1/S0 ‚Ä¢ I:L1/S0</b></div>
      <label class="card tog"><small>‡πÄ‡∏™‡∏µ‡∏¢‡∏á</small><input type="checkbox" id="toggleSound" checked></label>
      <label class="card tog"><small>‡∏™‡∏±‡πà‡∏ô</small><input type="checkbox" id="toggleVibrate" checked></label>
    </div>

    <div class="boardWrap">
      <div class="overlay" id="motOverlay" style="display:none;">
        <div class="overlayBox" id="motText">Level 10! ‡πÄ‡∏Å‡πà‡∏á‡∏°‡∏≤‡∏Å!</div>
      </div>

      <div class="gameover" id="gameOver" style="display:none;">
        <div class="goPanel">
          <div class="goTitle">‡∏õ‡πä‡∏≤‡∏£‡∏±‡∏Å‡∏•‡∏π‡∏Å‡πÜ‡∏ô‡∏∞‡∏Ñ‡∏£‡∏±‡∏ö</div>
          <div class="goSub">‡∏´‡∏°‡∏î‡πÄ‡∏ß‡∏•‡∏≤‡πÅ‡∏•‡πâ‡∏ß ‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏ô‡∏∞!</div>
          <div class="controls" style="justify-content:center; gap:12px">
            <button class="btn big" id="newBtn">‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÄ‡∏•‡πà‡∏ô‡πÉ‡∏´‡∏°‡πà</button>
            <button class="btn secondary big" id="retryBtn">‡πÄ‡∏•‡πà‡∏ô‡∏î‡πà‡∏≤‡∏ô‡πÄ‡∏î‡∏¥‡∏°</button>
          </div>
        </div>
      </div>

      <div class="overlay" id="readyGo" style="display:none;">
        <div class="overlayBox" id="readyText" style="font-size:42px;">3</div>
      </div>

      <div class="overlay" id="tutor" style="display:none;">
        <div class="overlayBox" style="max-width:90%; font-size:16px;">
          ‡πÅ‡∏ï‡∏∞‡∏Å‡∏£‡∏∞‡∏î‡∏≤‡∏ô‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÇ‡∏ü‡∏Å‡∏±‡∏™ ‡πÅ‡∏•‡πâ‡∏ß‡πÉ‡∏ä‡πâ‡∏õ‡∏∏‡πà‡∏°‡∏•‡∏π‡∏Å‡∏®‡∏£ / WASD ‡∏´‡∏£‡∏∑‡∏≠‡∏õ‡∏∏‡πà‡∏°‡∏ó‡∏¥‡∏®‡∏ó‡∏≤‡∏á‡∏î‡πâ‡∏≤‡∏ô‡∏Ç‡∏ß‡∏≤‡∏•‡πà‡∏≤‡∏á<br>
          ‡πÄ‡∏Å‡πá‡∏ö ‚≠êÔ∏è ‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö (‡∏î‡πà‡∏≤‡∏ô‡∏ó‡∏µ‡πà 10 ‡πÄ‡∏õ‡πá‡∏ô üçìüçíüçâüçé) ‚Äî ‡πÄ‡∏ß‡∏•‡∏≤‡∏ï‡πà‡∏≠‡∏î‡πà‡∏≤‡∏ô 25 ‡∏ß‡∏¥ ‚ú®
          <div style="margin-top:10px"><button class="btn small" id="tutorOk">‡πÇ‡∏≠‡πÄ‡∏Ñ!</button></div>
        </div>
      </div>

      <div class="board" id="board" tabindex="0" title="‡πÅ‡∏ï‡∏∞‡∏Å‡∏£‡∏∞‡∏î‡∏≤‡∏ô‡∏Å‡πà‡∏≠‡∏ô ‡πÅ‡∏•‡πâ‡∏ß‡πÉ‡∏ä‡πâ‡∏õ‡∏∏‡πà‡∏°‡∏ó‡∏¥‡∏®‡∏ó‡∏≤‡∏á">
        <div class="grid" id="grid"></div>
      </div>
      <div class="tip">Tips: ‡πÅ‡∏ï‡∏∞‡∏Å‡∏£‡∏∞‡∏î‡∏≤‡∏ô‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÇ‡∏ü‡∏Å‡∏±‡∏™ ‡πÅ‡∏•‡πâ‡∏ß‡πÉ‡∏ä‡πâ‡∏õ‡∏∏‡πà‡∏°‡∏•‡∏π‡∏Å‡∏®‡∏£ / WASD ‡∏´‡∏£‡∏∑‡∏≠‡∏Å‡∏î‡∏õ‡∏∏‡πà‡∏°‡∏ó‡∏¥‡∏®‡∏ó‡∏≤‡∏á‡∏î‡πâ‡∏≤‡∏ô‡∏•‡πà‡∏≤‡∏á‡∏Ç‡∏ß‡∏≤</div>
    </div>
  </div>

  <!-- Character Select Modal (‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Å‡πà‡∏≠‡∏ô‡πÄ‡∏£‡∏¥‡πà‡∏°) -->
  <div class="charselect" id="charSelect">
    <div class="charbox">
      <h2>‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ï‡∏±‡∏ß‡∏•‡∏∞‡∏Ñ‡∏£‡∏Å‡πà‡∏≠‡∏ô‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÄ‡∏•‡πà‡∏ô</h2>
      <div class="charoptions">
        <div class="charopt" data-char="Mickie">
          <div class="emo">üßõ</div>
          <div><div><b>Mickie</b></div><small class="note">‡πÅ‡∏£‡∏á‡πÉ‡∏à‡∏•‡πâ‡∏ô! ‡∏ß‡∏¥‡πà‡∏á‡∏•‡∏∏‡∏¢‡πÄ‡∏Å‡πá‡∏ö‡∏î‡∏≤‡∏ß</small></div>
        </div>
        <div class="charopt" data-char="Indy">
          <div class="emo">üßü</div>
          <div><div><b>Indy</b></div><small class="note">‡∏™‡∏≤‡∏¢‡∏ä‡∏¥‡∏• ‡πÄ‡∏î‡∏¥‡∏ô‡πÄ‡∏ô‡∏µ‡∏¢‡∏ô‡πÄ‡∏Å‡πá‡∏ö‡πÑ‡∏î‡πâ‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏¢ ‡πÜ</small></div>
        </div>
      </div>
      <div class="charactions">
        <button class="btn ghost" id="cancelPick" disabled>‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
        <button class="btn big" id="confirmPick" disabled>‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÄ‡∏•‡πà‡∏ô</button>
      </div>
      <div class="note" style="margin-top:8px;">‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ï‡∏±‡∏ß‡∏•‡∏∞‡∏Ñ‡∏£‡∏Å‡πà‡∏≠‡∏ô‡∏ñ‡∏∂‡∏á‡∏à‡∏∞‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÄ‡∏•‡πà‡∏ô‡πÑ‡∏î‡πâ</div>
    </div>
  </div>

  <!-- Floating D-Pad -->
  <div class="pad" id="pad">
    <div class="pbtn blank"></div>
    <div class="pbtn" data-dir="up">‚ñ≤</div>
    <div class="pbtn blank"></div>
    <div class="pbtn" data-dir="left">‚óÄ</div>
    <div class="pbtn" data-dir="ok">‚óé</div>
    <div class="pbtn" data-dir="right">‚ñ∂</div>
    <div class="pbtn blank"></div>
    <div class="pbtn" data-dir="down">‚ñº</div>
    <div class="pbtn blank"></div>
  </div>

  <script>
    // ===== Config =====
    const GRID_COLS=15, GRID_ROWS=10, TILE=44, START_COINS=3, LEVEL_TIME=25;
    const STAR="‚≠êÔ∏è"; const FRUITS=["üçì","üçí","üçâ","üçé"];

    // ‡∏û‡∏≤‡∏™‡πÄ‡∏ó‡∏•‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏û‡∏∑‡πâ‡∏ô‡∏´‡∏•‡∏±‡∏á‡∏ï‡∏≤‡∏°‡πÄ‡∏•‡πÄ‡∏ß‡∏• (‡∏ß‡∏ô‡∏•‡∏π‡∏õ)
    const PASTELS = [
      ['#fef6ff','#e9f0ff','#fff4f0'],
      ['#e6fbff','#fef7ff','#f4fff5'],
      ['#fff7e6','#e6fff7','#f0f3ff'],
      ['#fdf0ff','#f2fff8','#fff6ed'],
      ['#eaf7ff','#fff0f5','#f7fff0'],
      ['#fff6f0','#f0f7ff','#f6fff6'],
    ];
    function applyLevelTheme(lv){
      const t = PASTELS[(lv-1) % PASTELS.length];
      document.body.style.background =
        `radial-gradient(800px 600px at 20% -10%, ${t[0]}, transparent),
         radial-gradient(800px 600px at 120% 110%, ${t[1]}, transparent),
         linear-gradient(180deg, ${t[2]}, #ffffff)`;
    }

    const CHARACTERS={
      Mickie:{label:"Mickie", class:"mickie", emoji:"üßõ"},
      Indy:{label:"Indy", class:"indy", emoji:"üßü"},
    };

    // ===== WebAudio: ‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡πÄ‡∏≠‡∏ü‡πÄ‡∏ü‡∏Å‡∏ï‡πå =====
    let audioCtx=null;
    function ensureAudio(){
      if(!soundOn) return; // ‡πÄ‡∏Ñ‡∏≤‡∏£‡∏û‡∏Å‡∏≤‡∏£‡∏õ‡∏¥‡∏î‡πÄ‡∏™‡∏µ‡∏¢‡∏á
      if(!audioCtx){
        const A=window.AudioContext||window.webkitAudioContext;
        audioCtx=new A();
      }
      if(audioCtx.state==='suspended') audioCtx.resume();
    }
    function beep({freq=880, dur=0.08, type='sine', vol=0.2}={}){
      if(!audioCtx || !soundOn) return;
      const t=audioCtx.currentTime;
      const o=audioCtx.createOscillator();
      const g=audioCtx.createGain();
      o.type=type; o.frequency.value=freq;
      g.gain.setValueAtTime(0, t);
      g.gain.linearRampToValueAtTime(vol, t+0.01);
      g.gain.exponentialRampToValueAtTime(0.0001, t+dur);
      o.connect(g).connect(audioCtx.destination);
      o.start(t); o.stop(t+dur+0.02);
    }
    function arpeggio(notes=[440,660,880], step=0.08, vol=0.22){
      if(!audioCtx || !soundOn) return;
      notes.forEach((f,i)=> setTimeout(()=>beep({freq:f,dur:0.07,vol,type:'triangle'}), i*step*1000));
    }
    const sfx = {
      pickup(isFruit){ ensureAudio(); if(isFruit) arpeggio([880,1180], 0.07, 0.20); else beep({freq:1100, dur:0.06, type:'square', vol:0.18}); },
      clear(){ ensureAudio(); arpeggio([660,880,1320], 0.09, 0.22); },
      over(){ ensureAudio(); arpeggio([440,330,220], 0.12, 0.20); },
      tick(){ ensureAudio(); beep({freq:480, dur:0.05, type:'sine', vol:0.15}); }
    };

    // ===== Settings (persist) =====
    let soundOn = JSON.parse(localStorage.getItem('kidStarsSound') ?? 'true');
    let vibrateOn = JSON.parse(localStorage.getItem('kidStarsVib') ?? 'true');

    // ===== State =====
    let gameStarted=false, gameOver=false, paused=false;
    let level=1, coins=[], coinIcons=[], player={x:1,y:1}, collected=0, need=START_COINS;
    let timeLeft=LEVEL_TIME, timerId=null, lowTickArmed=false;
    let character=null; let score=0;
    let combo=0; let lastPickupAt=0;

    const best = JSON.parse(localStorage.getItem("kidStarsBest")||"{}");
    if(!best.Mickie) best.Mickie={level:1, score:0};
    if(!best.Indy) best.Indy={level:1, score:0};

    // ===== DOM =====
    const gridEl=document.getElementById('grid');
    const boardEl=document.getElementById('board');
    const hudChar=document.getElementById('hudChar');
    const hudLevel=document.getElementById('hudLevel');
    const hudCoins=document.getElementById('hudCoins');
    const hudTime=document.getElementById('hudTime');
    const hudScore=document.getElementById('hudScore');
    const hudBest=document.getElementById('hudBest');
    const pauseBtn=document.getElementById('pauseBtn');
    const restartBtn=document.getElementById('restartBtn');
    const backBtn=document.getElementById('backBtn');
    const motOverlay=document.getElementById('motOverlay');
    const motText=document.getElementById('motText');
    const gameOverEl=document.getElementById('gameOver');
    const newBtn=document.getElementById('newBtn');
    const retryBtn=document.getElementById('retryBtn');
    const picker=document.getElementById('picker');
    const pad=document.getElementById('pad');
    const readyGo=document.getElementById('readyGo');
    const readyText=document.getElementById('readyText');
    const tutor=document.getElementById('tutor');
    const tutorOk=document.getElementById('tutorOk');
    const charSelect=document.getElementById('charSelect');
    const confirmPick=document.getElementById('confirmPick');
    const cancelPick=document.getElementById('cancelPick');
    const charOpts=[...document.querySelectorAll('.charopt')];
    const toggleSound=document.getElementById('toggleSound');
    const toggleVibrate=document.getElementById('toggleVibrate');

    // ===== Helpers =====
    function buildGrid(){
      gridEl.style.gridTemplateColumns=`repeat(${GRID_COLS}, ${TILE}px)`;
      gridEl.style.gridTemplateRows=`repeat(${GRID_ROWS}, ${TILE}px)`;
      gridEl.innerHTML='';
      for(let y=0;y<GRID_ROWS;y++){
        for(let x=0;x<GRID_COLS;x++){
          const cell=document.createElement('div');
          cell.className='cell'; cell.dataset.x=x; cell.dataset.y=y;
          gridEl.appendChild(cell);
        }
      }
    }

    // ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏Ç‡∏≠‡∏á‡πÄ‡∏Å‡πá‡∏ö ‡πÄ‡∏û‡∏¥‡πà‡∏° 10% ‡∏ï‡πà‡∏≠‡πÄ‡∏•‡πÄ‡∏ß‡∏•
    function requiredCoins(lv){
      return Math.max(1, Math.ceil(START_COINS * Math.pow(1.10, lv - 1)));
    }

    function randInt(min,max){ return Math.floor(Math.random()*(max-min+1))+min; }

    function renderHUD(){
      hudChar.textContent= character ? `${CHARACTERS[character].label} ${CHARACTERS[character].emoji}` : '-';
      hudLevel.textContent=level;
      hudCoins.textContent=`${collected}/${need}`;
      hudTime.textContent=`${Math.max(0,timeLeft)}s`;
      hudTime.style.color = timeLeft<=5 ? '#ef4444' : '';
      hudScore.textContent=score;
      hudBest.textContent=`M:L${best.Mickie.level}/S${best.Mickie.score} ‚Ä¢ I:L${best.Indy.level}/S${best.Indy.score}`;
      boardEl.classList.toggle('lowtime', timeLeft<=5);
    }

    function renderActors(){
      const cells=gridEl.children;
      for(const cell of cells){ cell.innerHTML=''; }
      for(let i=0;i<coins.length;i++){
        const c=coins[i], icon=coinIcons[i]||STAR;
        const idx=c.y*GRID_COLS+c.x; const cell=cells[idx];
        const d=document.createElement('div'); d.className='coin'; d.textContent=icon; cell.appendChild(d);
      }
      const pidx=player.y*GRID_COLS+player.x; const pcell=cells[pidx];
      const pdiv=document.createElement('div'); pdiv.className='player '+(character?CHARACTERS[character].class:''); pdiv.textContent= character ? CHARACTERS[character].emoji : 'üôÇ'; pcell.appendChild(pdiv);
    }

    function popupScoreAt(x,y, text){
      const idx=y*GRID_COLS+x; const cell=gridEl.children[idx];
      const p=document.createElement('div'); p.className='pop'; p.textContent=text;
      cell.appendChild(p); setTimeout(()=>p.remove(), 800);
    }

    function setupPicker(){
      picker.innerHTML='';
      Object.keys(CHARACTERS).forEach((k)=>{
        const opt=document.createElement('div');
        const active=character===k;
        opt.className='opt'+(active?' active':'');
        opt.innerHTML=`<span style="font-size:22px">${CHARACTERS[k].emoji}</span><span>${CHARACTERS[k].label}</span>`;
        opt.onclick=()=>{ character=k; setupPicker(); renderHUD(); };
        picker.appendChild(opt);
      });
    }

    function makeCoinIcons(lv, count){
      if(lv%10!==0){ return Array.from({length:count}, ()=>STAR); }
      const arr=[]; for(let i=0;i<count;i++){ arr.push(FRUITS[randInt(0,FRUITS.length-1)]); }
      if(count>1){
        const allSame=arr.every(v=>v===arr[0]);
        if(allSame){ const idx=randInt(0,count-1); const alt=FRUITS.find(f=>f!==arr[0])||FRUITS[0]; arr[idx]=alt; }
      }
      return arr;
    }

    function applyTutorialIfFirstTime(){
      const seen = localStorage.getItem('kidStarsTutorSeen');
      if(!seen){
        tutor.style.display='flex';
        tutorOk.onclick = ()=>{ tutor.style.display='none'; localStorage.setItem('kidStarsTutorSeen','1'); };
      }
    }

    function setupLevel(lv=level){
      applyLevelTheme(lv);
      player={x:1,y:1};
      const placed=new Set([player.x+','+player.y]);
      coins=[];
      const count=requiredCoins(lv);
      let guard=0;
      while(coins.length<count && guard<8000){
        guard++;
        const p={x:randInt(0,GRID_COLS-1), y:randInt(0,GRID_ROWS-1)};
        const k=p.x+','+p.y;
        if(!placed.has(k)){ placed.add(k); coins.push(p); }
      }
      collected=0; need=count; timeLeft=LEVEL_TIME; gameOver=false; lowTickArmed=false;
      combo=0; lastPickupAt=0;
      coinIcons=makeCoinIcons(lv, coins.length);
      renderHUD(); renderActors();
    }

    function levelReadyCountdown(cb){
      readyGo.style.display='flex';
      let n=3; readyText.textContent=n;
      const t=setInterval(()=>{
        n--; if(n>0){ readyText.textContent=n; } else {
          readyText.textContent='Go!'; setTimeout(()=>{ readyGo.style.display='none'; }, 250);
          clearInterval(t); cb && cb();
        }
      }, 700);
    }

    function startTimer(){
      stopTimer();
      timerId=setInterval(()=>{
        if(paused) return;
        timeLeft--; 
        if(timeLeft<=5){
          if(!lowTickArmed){ lowTickArmed=true; }
          sfx.tick();
        }
        renderHUD();
        if(timeLeft<=0 && collected<need){ triggerGameOver(); }
      }, 1000);
    }
    function stopTimer(){ if(timerId){ clearInterval(timerId); timerId=null; } }

    function saveBests(){
      if(character){
        if(level>best[character].level) best[character].level=level;
        if(score>best[character].score) best[character].score=score;
        localStorage.setItem("kidStarsBest", JSON.stringify(best));
      }
    }

    function vibrate(ms=20){ if(vibrateOn && navigator.vibrate) navigator.vibrate(ms); }

    function triggerGameOver(){
      if(gameOver) return;
      gameOver=true; stopTimer(); saveBests(); sfx.over(); gameOverEl.style.display='flex'; vibrate(60);
    }
    function hideGameOver(){ gameOverEl.style.display='none'; }

    function showMotivation(nextLevel){
      motText.textContent=`Level ${nextLevel}! ‡πÄ‡∏Å‡πà‡∏á‡∏°‡∏≤‡∏Å‡πÜ ‡πÄ‡∏•‡∏¢ ‚ú®`;
      motOverlay.style.display='flex';
      setTimeout(()=> motOverlay.style.display='none', 2000);
    }

    function addScoreOnPickup(base, x, y){
      const now = performance.now();
      if(now - lastPickupAt <= 2000){ combo++; } else { combo=1; }
      lastPickupAt = now;

      const mult = Math.min(combo, 5); // ‡∏•‡∏¥‡∏°‡∏¥‡∏ï x5
      const gain = base * mult;
      score += gain;
      popupScoreAt(x,y, `+${gain}${mult>1?` (x${mult})`:''}`);
    }
    function addScoreOnClear(){ score+=Math.max(0,timeLeft)*5; }

    function tryMove(dx,dy){
      if(!gameStarted || gameOver || paused) return;
      const nx=Math.max(0, Math.min(GRID_COLS-1, player.x+dx));
      const ny=Math.max(0, Math.min(GRID_ROWS-1, player.y+dy));
      player={x:nx,y:ny};
      const idx=coins.findIndex(c=>c.x===nx && c.y===ny);
      if(idx>=0){
        const icon = coinIcons[idx];
        coins.splice(idx,1); coinIcons.splice(idx,1);
        collected++;
        addScoreOnPickup(10, nx, ny);
        sfx.pickup(icon && icon!=='‚≠êÔ∏è');
        vibrate(15);
        renderHUD();
      }
      renderActors();
      if(collected>=need){
        addScoreOnClear(); sfx.clear(); vibrate(30);
        saveBests();
        const nextLevel=level+1;
        if(nextLevel%10===0) showMotivation(nextLevel);
        level=nextLevel; setupLevel(nextLevel);
        levelReadyCountdown(()=>{ startTimer(); });
      }
    }

    // ===== Character Select flow =====
    let pendingPick=null;
    charOpts.forEach(opt=>{
      opt.addEventListener('click', ()=>{
        charOpts.forEach(o=>o.classList.remove('active'));
        opt.classList.add('active');
        pendingPick = opt.getAttribute('data-char');
        confirmPick.disabled = false;
        cancelPick.disabled = false;
      });
    });
    confirmPick.addEventListener('click', ()=>{
      if(!pendingPick) return;
      character = pendingPick;
      setupPicker(); renderHUD();
      charSelect.style.display='none';
      applyTutorialIfFirstTime();
      level=1; score=0; gameOver=false; paused=false;
      setupLevel(1);
      levelReadyCountdown(()=>{ ensureAudio(); gameStarted=true; showIngameButtons(true); startTimer(); boardEl.focus(); });
    });
    cancelPick.addEventListener('click', ()=>{ /* ‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Å‡πà‡∏≠‡∏ô ‡∏à‡∏∂‡∏á‡πÑ‡∏°‡πà‡∏õ‡∏¥‡∏î modal */ });

    // Visibility pause
    document.addEventListener('visibilitychange', ()=>{
      if(document.hidden && gameStarted && !gameOver){ setPaused(true); }
    });

    // Keyboard & D-Pad
    const boardElKeyHandler = (e)=>{
      if(!gameStarted || gameOver) return;
      if(e.key==='p' || e.key==='P'){ togglePause(); return e.preventDefault(); }
      switch(e.key){
        case 'ArrowUp': case 'w': case 'W': tryMove(0,-1); break;
        case 'ArrowDown': case 's': case 'S': tryMove(0,1); break;
        case 'ArrowLeft': case 'a': case 'A': tryMove(-1,0); break;
        case 'ArrowRight': case 'd': case 'D': tryMove(1,0); break;
        default: return;
      }
      e.preventDefault();
    };
    document.getElementById('board').addEventListener('keydown', boardElKeyHandler);
    document.getElementById('pad').addEventListener('touchstart', (e)=>{ e.preventDefault(); }, {passive:false});
    document.querySelectorAll('.pbtn').forEach(btn=>{
      btn.addEventListener('click', ()=>{
        ensureAudio();
        const dir=btn.getAttribute('data-dir');
        if(dir==='up') tryMove(0,-1);
        if(dir==='down') tryMove(0,1);
        if(dir==='left') tryMove(-1,0);
        if(dir==='right') tryMove(1,0);
      });
    });

    // Buttons
    function showIngameButtons(on){
      pauseBtn.style.display = on ? 'inline-flex' : 'none';
      restartBtn.style.display = on ? 'inline-flex' : 'none';
      backBtn.style.display = on ? 'inline-flex' : 'none';
    }
    function startGame(){
      // ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ú‡πà‡∏≤‡∏ô‡∏´‡∏ô‡πâ‡∏≤‡∏ï‡∏±‡∏ß‡∏•‡∏∞‡∏Ñ‡∏£‡πÅ‡∏•‡πâ‡∏ß
      setupLevel(1); ensureAudio(); gameStarted=true; paused=false; gameOver=false;
      showIngameButtons(true); boardEl.focus(); startTimer();
    }
    function restartLevel(){
      if(gameOver){ hideGameOver(); }
      setupLevel(level); paused=false; boardEl.focus(); levelReadyCountdown(()=> startTimer());
    }
    function backToMenu(){
      gameStarted=false; gameOver=false; paused=false; stopTimer(); renderHUD(); renderActors();
      showIngameButtons(false);
      charSelect.style.display='flex';
      pendingPick=null; confirmPick.disabled=true; cancelPick.disabled=true;
      charOpts.forEach(o=>o.classList.remove('active'));
      character=null; renderHUD(); setupPicker();
    }
    function setPaused(p){
      if(!gameStarted || gameOver) return;
      paused = p;
      pauseBtn.textContent = p ? '‡πÄ‡∏•‡πà‡∏ô‡∏ï‡πà‡∏≠ (P)' : '‡∏´‡∏¢‡∏∏‡∏î‡∏û‡∏±‡∏Å (P)';
    }
    function togglePause(){ setPaused(!paused); }

    pauseBtn.onclick=()=>{ ensureAudio(); togglePause(); };
    restartBtn.onclick=()=>{ ensureAudio(); restartLevel(); };
    backBtn.onclick=backToMenu;
    newBtn.onclick=()=>{ hideGameOver(); ensureAudio(); level=1; score=0; startGame(); };
    retryBtn.onclick=()=>{ hideGameOver(); ensureAudio(); restartLevel(); };

    // Toggles persist
    toggleSound.checked = soundOn;
    toggleVibrate.checked = vibrateOn;
    toggleSound.addEventListener('change', ()=>{ soundOn = toggleSound.checked; localStorage.setItem('kidStarsSound', JSON.stringify(soundOn)); if(soundOn) ensureAudio(); });
    toggleVibrate.addEventListener('change', ()=>{ vibrateOn = toggleVibrate.checked; localStorage.setItem('kidStarsVib', JSON.stringify(vibrateOn)); });

    // Init
    function setupPickerInitial(){
      picker.innerHTML='';
      Object.keys(CHARACTERS).forEach((k)=>{
        const opt=document.createElement('div');
        opt.className='opt';
        opt.innerHTML=`<span style="font-size:24px">${CHARACTERS[k].emoji}</span><span>${CHARACTERS[k].label}</span>`;
        picker.appendChild(opt);
      });
    }
    applyLevelTheme(1);
    buildGrid(); setupPickerInitial(); setupLevel(1); renderHUD(); renderActors();
    boardEl.addEventListener('click', ()=>{ ensureAudio(); boardEl.focus(); });

    // ‡πÄ‡∏õ‡∏¥‡∏î‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ï‡∏±‡∏ß‡∏•‡∏∞‡∏Ñ‡∏£‡∏ï‡∏±‡πâ‡∏á‡πÅ‡∏ï‡πà‡πÇ‡∏´‡∏•‡∏î
    charSelect.style.display='flex';
  </script>
</body>
</html>
